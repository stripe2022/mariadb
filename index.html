<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventario → PDF</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 20px; background: #0b1220; color: #e9f0ff; }
    .container { max-width: 1000px; margin: auto; }
    h1 { margin: 0 0 20px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 12px; border-bottom: 1px solid #22304d; }
    th { text-align: left; color: #9fb0d3; }
    td.num { text-align: right; }
    td.costo { color: #ef4444; font-weight: 600; }
    td.venta { color: #22c55e; font-weight: 600; }
    button { margin-top: 10px; padding: 8px 14px; border: none; background: #4f8cff; color: #fff; border-radius: 6px; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Inventario Tienda Barylie</h1>
    <input id="fileInput" type="file" accept=".csv,.tsv,.txt" />
    <button id="btnPdf" disabled>Generar PDF</button>
    <div id="preview"></div>
  </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const btnPdf = document.getElementById('btnPdf');
    const preview = document.getElementById('preview');

    let parsed = { headers: [], rows: [] };

    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (!file) return;
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: (res) => {
          parsed.headers = res.meta.fields;
          parsed.rows = res.data;
          // Ordenar alfabéticamente por la primera columna (Producto)
          parsed.rows.sort((a, b) => {
            const nameA = (a[parsed.headers[0]] || '').toString().toLowerCase();
            const nameB = (b[parsed.headers[0]] || '').toString().toLowerCase();
            return nameA.localeCompare(nameB);
          });
          buildPreview();
          btnPdf.disabled = false;
        }
      });
    });

    function buildPreview() {
      preview.innerHTML = '';
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      parsed.headers.forEach(h => {
        const th = document.createElement('th'); th.textContent = h; trh.appendChild(th);
      });
      thead.appendChild(trh);
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      parsed.rows.slice(0,50).forEach(r => {
        const tr = document.createElement('tr');
        parsed.headers.forEach(h => {
          const td = document.createElement('td');
          let val = r[h];
          if (h.toLowerCase().includes('costo')) {
            td.textContent = '$' + Number(val).toLocaleString();
            td.classList.add('num','costo');
          } else if (h.toLowerCase().includes('precioventa')) {
            td.textContent = '$' + Number(val).toLocaleString();
            td.classList.add('num','venta');
          } else if (h.toLowerCase().includes('stock')) {
            td.textContent = Number(val).toLocaleString();
            td.classList.add('num');
          } else {
            td.textContent = val;
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      preview.appendChild(table);
    }

    btnPdf.addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const now = new Date();
      const fechaHora = now.toLocaleDateString('es-ES') + ' ' + now.toLocaleTimeString('es-ES');

      const headers = parsed.headers.map(h => ({ content: h, styles: { halign: h.match(/costo|precio|stock/i) ? 'right' : 'left' } }));
      const body = parsed.rows.map(r => parsed.headers.map(h => {
        let val = r[h];
        if (h.toLowerCase().includes('costo')) {
          return { content: '$' + Number(val).toLocaleString(), styles: { textColor: [239,68,68], halign: 'right', fontStyle: 'bold' } };
        } else if (h.toLowerCase().includes('precioventa')) {
          return { content: '$' + Number(val).toLocaleString(), styles: { textColor: [34,197,94], halign: 'right', fontStyle: 'bold' } };
        } else if (h.toLowerCase().includes('stock')) {
          return { content: Number(val).toLocaleString(), styles: { halign: 'right' } };
        } else {
          return val;
        }
      }));

      doc.setFontSize(16);
      doc.text('Inventario Tienda Barylie', 14, 20);
      doc.setFontSize(11);
      doc.text('Generado: ' + fechaHora, 14, 36);

      doc.autoTable({
        head: [headers],
        body: body,
        startY: 50,
        styles: { fontSize: 9 },
        columnStyles: {
          1: { halign: 'right' },
          2: { halign: 'right' },
          3: { halign: 'right' }
        }
      });

      doc.save('inventario_barylie.pdf');
    });
  </script>
</body>
</html>